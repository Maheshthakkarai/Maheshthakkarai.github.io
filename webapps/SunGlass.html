<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sun Glass - Sunglass Sizing, Style & Virtual Try-On</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --font-family-main: 'Poppins', sans-serif;
            --color-bg: #e0e5ec; --color-text: #333; --color-primary: #007bff; --color-primary-text: #fff;
            --color-card-bg: #e0e5ec; --color-input-bg: #dde1e7; --color-input-border: #d1d9e6;
            --color-shadow-light: #ffffff; --color-shadow-dark: #a3b1c6;
            --color-modal-bg: rgba(240, 245, 250, 0.95); --color-modal-text: #333;
            --color-border: #c8d0e0; --color-icon: #555; --color-icon-hover: #007bff;
            --color-tooltip-bg: #333; --color-tooltip-text: #fff; --glow-color: rgba(0, 123, 255, 0.3);
            --shadow-neumorphic: 6px 6px 12px var(--color-shadow-dark), -6px -6px 12px var(--color-shadow-light);
            --shadow-neumorphic-inset: inset 4px 4px 8px var(--color-shadow-dark), inset -4px -4px 8px var(--color-shadow-light);
            --shadow-neumorphic-pressed: 2px 2px 5px var(--color-shadow-dark), -2px -2px 5px var(--color-shadow-light);
        }
        .dark-theme {
            --color-bg: #2c323d; --color-text: #e0e5ec; --color-primary: #4dabf7; --color-primary-text: #111;
            --color-card-bg: #353c4a; --color-input-bg: #252a33; --color-input-border: #404855;
            --color-shadow-light: #3a4250; --color-shadow-dark: #1e222a;
            --color-modal-bg: rgba(44, 50, 61, 0.95); --color-modal-text: #e0e5ec;
            --color-border: #4a5363; --color-icon: #a0a8b8; --color-icon-hover: #4dabf7;
            --color-tooltip-bg: #e0e5ec; --color-tooltip-text: #2c323d; --glow-color: rgba(77, 171, 247, 0.4);
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family-main); background-color: var(--color-bg); color: var(--color-text); line-height: 1.6; transition: background-color 0.3s ease, color 0.3s ease; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
        .app-container { width: 100%; max-width: 700px; margin: 0 auto; padding: 20px; background-color: var(--color-card-bg); border-radius: 20px; box-shadow: var(--shadow-neumorphic); transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--color-border); }
        header h1 { font-size: clamp(1.5rem, 5vw, 2.2rem); font-weight: 600; color: var(--color-primary); }
        .header-actions button { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s, box-shadow 0.2s; margin-left: 10px; display: inline-flex; align-items: center; justify-content: center; }
        .header-actions button:hover { background-color: var(--color-input-bg); box-shadow: var(--shadow-neumorphic-inset); }
        .header-actions svg { width: 24px; height: 24px; fill: var(--color-icon); transition: fill 0.2s; }
        .header-actions button:hover svg { fill: var(--color-icon-hover); }
        .mode-toggle-container { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; padding: 8px; background-color: var(--color-input-bg); border-radius: 10px; box-shadow: var(--shadow-neumorphic-inset); }
        .mode-toggle-container label { margin-right: 10px; font-weight: 500; font-size: 0.9rem; }
        .mode-toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .mode-toggle-switch input { opacity: 0; width: 0; height: 0; }
        .mode-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--color-border); transition: .4s; border-radius: 26px; }
        .mode-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0px 0px 3px rgba(0,0,0,0.3); }
        input:checked + .mode-slider { background-color: var(--color-primary); }
        input:focus + .mode-slider { box-shadow: 0 0 1px var(--color-primary); }
        input:checked + .mode-slider:before { transform: translateX(24px); }
        .mode-toggle-text { font-size: 0.9rem; margin-left: 8px; font-weight: 500; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; display: flex; align-items: center; }
        .form-group label .asterisk { color: var(--color-primary); margin-left: 4px; font-weight: bold; }
        .form-group input[type="number"], .form-group select { padding: 12px 15px; border-radius: 10px; border: 1px solid var(--color-input-border); background-color: var(--color-input-bg); color: var(--color-text); font-family: var(--font-family-main); font-size: 1rem; box-shadow: var(--shadow-neumorphic-inset); transition: border-color 0.3s, box-shadow 0.3s; width: 100%; }
        .form-group input[type="number"]:focus, .form-group select:focus { outline: none; border-color: var(--color-primary); box-shadow: var(--shadow-neumorphic-inset), 0 0 0 2px var(--glow-color); }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .tooltip-container { position: relative; display: inline-block; margin-left: 8px; }
        .tooltip-trigger-btn { background: none; border: none; padding: 0; margin: 0; cursor: help; display: inline-flex; align-items: center; justify-content: center; color: var(--color-icon); }
        .tooltip-trigger-btn svg { width: 16px; height: 16px; fill: currentColor; }
        .tooltip-trigger-btn:hover svg, .tooltip-trigger-btn:focus svg { fill: var(--color-icon-hover); }
        .tooltip-popup { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-5px); background-color: var(--color-tooltip-bg); color: var(--color-tooltip-text); padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 400; line-height: 1.4; width: max-content; max-width: 250px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10; text-align: left; }
        .tooltip-popup::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: var(--color-tooltip-bg) transparent transparent transparent; }
        .unit-toggle-group { display: flex; align-items: center; margin-bottom: 20px; padding: 10px; background-color: var(--color-input-bg); border-radius: 10px; box-shadow: var(--shadow-neumorphic-inset); }
        .unit-toggle-group label { margin-right: 10px; font-weight: 500; }
        .unit-toggle-group button { padding: 8px 15px; margin: 0 5px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background-color 0.3s, color 0.3s, box-shadow 0.3s; }
        .unit-toggle-group button.active { background-color: var(--color-primary); color: var(--color-primary-text); box-shadow: var(--shadow-neumorphic); }
        .unit-toggle-group button:not(.active) { background-color: var(--color-card-bg); color: var(--color-text); box-shadow: var(--shadow-neumorphic-pressed); }
        .action-buttons { display: flex; gap: 15px; margin-top: 20px; justify-content: flex-end; }
        .btn { padding: 12px 25px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; font-size: 1rem; transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s; box-shadow: var(--shadow-neumorphic); }
        .btn:active { transform: translateY(1px); box-shadow: var(--shadow-neumorphic-pressed); }
        .btn-primary { background-color: var(--color-primary); color: var(--color-primary-text); }
        .btn-primary:hover { background-color: color-mix(in srgb, var(--color-primary) 85%, black); }
        .btn-secondary { background-color: var(--color-card-bg); color: var(--color-text); }
        .btn-secondary:hover { background-color: var(--color-input-bg); }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; }
        .results-container { margin-top: 30px; padding: 25px; background-color: var(--color-card-bg); border-radius: 15px; box-shadow: var(--shadow-neumorphic); border-top: 3px solid var(--color-primary); }
        .results-container h2 { text-align: center; margin-bottom: 20px; font-weight: 600; color: var(--color-primary); }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .result-item { padding: 15px; background-color: var(--color-input-bg); border-radius: 10px; text-align: center; box-shadow: var(--shadow-neumorphic-inset); }
        .result-item .label { font-size: 0.9rem; color: color-mix(in srgb, var(--color-text) 70%, transparent); margin-bottom: 5px; }
        .result-item .value { font-size: 1.4rem; font-weight: 600; color: var(--color-text); }
        .result-item .unit { font-size: 0.8rem; margin-left: 3px; }
        .results-actions { display: flex; justify-content: center; margin-bottom: 20px; }
        .btn-copy { background-color: var(--color-input-bg); color: var(--color-text); padding: 8px 15px; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; }
        .btn-copy svg { width: 16px; height: 16px; fill: currentColor; }
        .face-shape-display { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 20px; margin-bottom: 20px; }
        .face-shape-visualizer svg { width: 100px; height: auto; max-height: 120px; fill: none; stroke: var(--color-primary); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; background-color: var(--color-input-bg); padding: 10px; border-radius: 10px; box-shadow: var(--shadow-neumorphic-inset); }
        .face-shape-info { width: 100%; padding: 15px; background-color: var(--color-input-bg); border-radius: 10px; box-shadow: var(--shadow-neumorphic-inset); text-align: center; }
        .face-shape-info h3 { font-size: 1.1rem; margin-bottom: 8px; font-weight: 600; }
        .face-shape-info p { font-size: 0.95rem; line-height: 1.5; }
        .suggested-styles-container { margin-top: 25px; }
        .suggested-styles-container h3 { text-align: center; margin-bottom: 15px; font-weight: 600; color: var(--color-primary); }
        .styles-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .style-card { padding: 15px; background-color: var(--color-input-bg); border-radius: 10px; box-shadow: var(--shadow-neumorphic-inset); text-align: center; display: flex; flex-direction: column; align-items: center; }
        .style-card .style-icon-wrapper svg.style-icon { width: 80px; height: 40px; stroke-width: 2px; margin-bottom: 10px; padding: 5px; background-color: color-mix(in srgb, var(--color-input-bg) 90%, var(--color-shadow-dark)); border-radius: 5px; }
        .style-card .style-icon-wrapper svg.style-icon * { fill: var(--color-primary-text); stroke: var(--color-primary); }
        .style-card .style-name { font-weight: 600; margin-bottom: 5px; font-size: 1rem; }
        .style-card .style-reason { font-size: 0.85rem; color: color-mix(in srgb, var(--color-text) 80%, transparent); line-height: 1.4; }
        .advanced-tips { margin-top: 20px; padding: 15px; background-color: var(--color-input-bg); border-radius: 10px; box-shadow: var(--shadow-neumorphic-inset); }
        .advanced-tips h3 { font-size: 1rem; margin-bottom: 10px; font-weight: 600; color: var(--color-primary); }
        .advanced-tips ul { list-style: none; padding-left: 0; }
        .advanced-tips li { font-size: 0.9rem; margin-bottom: 8px; padding-left: 20px; position: relative; }
        .advanced-tips li::before { content: '💡'; position: absolute; left: 0; top: 1px; color: var(--color-primary); }
        .error-message { color: #dc3545; background-color: color-mix(in srgb, #dc3545 15%, transparent); padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 0.9rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 20px; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--color-modal-bg); backdrop-filter: blur(5px); color: var(--color-modal-text); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        .modal-content h2 { margin-top: 0; margin-bottom: 20px; color: var(--color-primary); }
        .modal-content h3 { margin-top: 20px; margin-bottom: 10px; font-size: 1.1rem; }
        .modal-content p, .modal-content ul { margin-bottom: 15px; font-size: 0.95rem; }
        .modal-content ul { padding-left: 20px; }
        .modal-content strong { font-weight: 600; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .modal-close-btn svg { width: 24px; height: 24px; fill: var(--color-icon); }
        .measurement-guide { margin-top: 15px; }
        .measurement-guide h4 { margin-bottom: 5px; font-size: 1rem; }
        .measurement-guide svg { width: 100%; max-width: 200px; height: auto; border: 1px solid var(--color-border); border-radius: 8px; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto; }
        
        .virtual-tryon-separator { height: 1px; background-color: var(--color-border); margin: 30px 0; box-shadow: var(--shadow-neumorphic-inset); }
        .virtual-tryon-container { margin-top: 20px; padding: 20px; background-color: var(--color-input-bg); border-radius: 15px; box-shadow: var(--shadow-neumorphic); }
        .virtual-tryon-container h2 { text-align: center; margin-bottom: 20px; font-weight: 600; color: var(--color-primary); }
        .upload-section { margin-bottom: 15px; text-align: center; }
        .upload-section .btn-upload { padding: 10px 20px; background-color: var(--color-primary); color: var(--color-primary-text); border-radius: 8px; cursor: pointer; display: inline-block; box-shadow: var(--shadow-neumorphic); }
        .upload-section input[type="file"] { display: none; }
        .tryon-area { position: relative; width: 100%; max-width: 400px; margin: 0 auto 20px auto; background-color: var(--color-card-bg); box-shadow: var(--shadow-neumorphic-inset); border-radius: 10px; overflow: hidden; }
        .tryon-area canvas { display: block; width: 100%; height: auto; border-radius: 10px; }
        .tryon-svg-overlay { position: absolute; cursor: grab; touch-action: none; }
        .tryon-svg-overlay svg.tryon-overlay-svg * { fill: rgba(30, 30, 30, 0.65) !important; stroke: currentColor !important; stroke-width: 2px !important; }
        .tryon-svg-overlay svg.tryon-overlay-svg .no-fill { fill: none !important; }
        .dark-theme .tryon-svg-overlay svg.tryon-overlay-svg * { fill: rgba(0, 0, 0, 0.65) !important; stroke: currentColor !important;}
        .dark-theme .tryon-svg-overlay svg.tryon-overlay-svg .no-fill { fill: none !important; }
        .tryon-svg-overlay:active { cursor: grabbing; }
        .vto-frame-colors { text-align: center; margin-bottom: 15px; }
        .vto-frame-colors h4 { font-size: 0.9rem; margin-bottom: 8px; font-weight: 500; }
        .color-swatch { width: 28px; height: 28px; border-radius: 50%; display: inline-block; margin: 0 5px; cursor: pointer; border: 2px solid var(--color-border); box-shadow: var(--shadow-neumorphic-pressed); transition: transform 0.2s, box-shadow 0.2s; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active { border-color: var(--color-primary); box-shadow: var(--shadow-neumorphic); }
        .sunglass-style-selector { text-align: center; margin-bottom: 15px; }
        .sunglass-style-selector h3 { margin-bottom: 10px; font-size: 1rem; }
        .sunglass-style-selector .style-preview-btn { display: inline-block; padding: 5px; margin: 5px; border-radius: 8px; cursor: pointer; background-color: var(--color-input-bg); box-shadow: var(--shadow-neumorphic-pressed); transition: box-shadow 0.2s; }
        .sunglass-style-selector .style-preview-btn:hover, .sunglass-style-selector .style-preview-btn.active { box-shadow: var(--shadow-neumorphic); outline: 2px solid var(--color-primary); }
        .sunglass-style-selector .style-preview-btn svg { width: 60px; height: 30px; stroke-width: 2px; }
        .sunglass-style-selector .style-preview-btn svg * { stroke: var(--color-primary); fill: none; }
        .tryon-controls { text-align: center; margin-top: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        .tryon-controls button { margin: 0; flex-grow: 1; min-width: 120px; }
        .tryon-main-actions { display: flex; justify-content: space-around; align-items: center; margin-top:15px; gap: 10px; }

        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .action-buttons { flex-direction: column; gap: 10px; } .btn { width: 100%; } .results-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); } .result-item .value { font-size: 1.2rem; } .tooltip-popup { max-width: 200px; } .face-shape-visualizer svg { width: 80px; } .styles-grid { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { body { padding: 10px; } .app-container { border-radius: 10px; } header { margin-bottom: 20px; } header h1 { font-size: 1.5rem; } .header-actions svg { width: 20px; height: 20px; } .form-group input[type="number"], .form-group select { padding: 10px 12px; font-size: 0.9rem; } .btn { padding: 10px 20px; font-size: 0.9rem; } .results-container { padding: 15px; } .result-item { padding: 10px; } .result-item .value { font-size: 1.1rem; } .face-shape-info { padding: 10px; } .modal-content { padding: 20px; } .tooltip-popup { font-size: 0.8rem; max-width: 180px; } .face-shape-visualizer svg { width: 70px; } .style-card svg.style-icon { width: 70px; height: 35px; } .tryon-controls button { min-width: calc(50% - 4px); flex-grow: 0; } .tryon-main-actions { flex-direction: column;} }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body x-data="sunGlassApp()" x-init="initApp()" :class="{ 'dark-theme': isDarkMode }" x-cloak>

    <div class="app-container">
        <!-- Header -->
        <header>
            <h1>Sun Glass</h1>
            <div class="header-actions">
                <button @click="toggleTheme()" :title="isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'">
                    <svg x-show="!isDarkMode" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 011.06-1.06l1.591 1.59a.75.75 0 11-1.06 1.06l-1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.836 17.836a.75.75 0 01-1.06 1.06l-1.591-1.59a.75.75 0 011.06-1.06l1.59 1.591zm-1.06-11.06a.75.75 0 011.06 1.06L16.537 9.17a.75.75 0 01-1.06-1.061l1.59-1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.836a.75.75 0 01-1.06-1.06l1.59-1.591a.75.75 0 111.061 1.06l-1.59 1.59zM6.106 7.164a.75.75 0 011.06-1.06l1.59 1.591a.75.75 0 01-1.06 1.061L6.106 7.164zM3 12a.75.75 0 01.75-.75h2.25A.75.75 0 016 12.75H3.75A.75.75 0 013 12zM4.164 16.537a.75.75 0 011.06 1.06l-1.59 1.591a.75.75 0 01-1.061-1.06l1.59-1.591z"/></svg>
                    <svg x-show="isDarkMode" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.502-4.702-10.502-10.502 0-3.683 1.87-6.98 4.694-8.804a.75.75 0 01.818.162z" clip-rule="evenodd" /></svg>
                </button>
                <button @click="isModalOpen = true" title="How to Use & Info">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.042.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </header>

        <!-- Mode Toggle -->
        <div class="mode-toggle-container">
            <label for="modeToggle">Quick Check</label>
            <label class="mode-toggle-switch">
                <input type="checkbox" id="modeToggle" x-model="isQuickCheckMode" @change="resetForm(); results.show = false">
                <span class="mode-slider"></span>
            </label>
            <span class="mode-toggle-text" x-text="isQuickCheckMode ? 'ON' : 'OFF (Standard)'"></span>
        </div>

        <!-- Input Form -->
        <form @submit.prevent="calculateAndDisplayResults()">
            <div class="unit-toggle-group">
                <label>Unit:</label>
                <button type="button" @click="inputs.unit = 'cm'" :class="{ 'active': inputs.unit === 'cm' }">cm</button>
                <button type="button" @click="inputs.unit = 'in'" :class="{ 'active': inputs.unit === 'in' }">in</button>
            </div>
            <div class="form-grid">
                <div class="form-group"><label for="sex">Sex <span class="asterisk">*</span></label><select id="sex" x-model="inputs.sex" required><option value="" disabled>Select sex</option><option value="Male">Male</option><option value="Female">Female</option><option value="Prefer not to say">Prefer not to say</option></select></div>
                <div class="form-group" x-show="!isQuickCheckMode" x-transition.opacity><label for="foreheadWidth">Forehead Width (<span x-text="inputs.unit"></span>)<span class="asterisk">*</span><div class="tooltip-container" x-data="{ visible: false }"><button type="button" class="tooltip-trigger-btn" @mouseenter="visible = true" @mouseleave="visible = false" @focus="visible = true" @blur="visible = false" aria-describedby="fw-tip"><svg viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.294-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 8.411V6.588zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg></button><div x-show="visible" x-transition.opacity.duration.150ms class="tooltip-popup" id="fw-tip">Width of forehead's widest region.</div></div></label><input type="number" id="foreheadWidth" x-model.number="inputs.foreheadWidth" placeholder="e.g. 13" step="0.1" min="0" :required="!isQuickCheckMode"></div>
                <div class="form-group"><label for="cheeksWidth">Cheeks Width (<span x-text="inputs.unit"></span>)<span class="asterisk">*</span><div class="tooltip-container" x-data="{ visible: false }"><button type="button" class="tooltip-trigger-btn" @mouseenter="visible = true" @mouseleave="visible = false" @focus="visible = true" @blur="visible = false" aria-describedby="cw-tip"><svg viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.294-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 8.411V6.588zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg></button><div x-show="visible" x-transition.opacity.duration.150ms class="tooltip-popup" id="cw-tip">Distance between outer corners of eyes.</div></div></label><input type="number" id="cheeksWidth" x-model.number="inputs.cheeksWidth" placeholder="e.g. 14" step="0.1" min="0" required></div>
                <div class="form-group" x-show="!isQuickCheckMode" x-transition.opacity><label for="jawlineLength">Jawline Length (<span x-text="inputs.unit"></span>)<span class="asterisk">*</span><div class="tooltip-container" x-data="{ visible: false }"><button type="button" class="tooltip-trigger-btn" @mouseenter="visible = true" @mouseleave="visible = false" @focus="visible = true" @blur="visible = false" aria-describedby="jl-tip"><svg viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.294-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 8.411V6.588zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg></button><div x-show="visible" x-transition.opacity.duration.150ms class="tooltip-popup" id="jl-tip">Chin to outer edge of ear (one side).</div></div></label><input type="number" id="jawlineLength" x-model.number="inputs.jawlineLength" placeholder="e.g. 11" step="0.1" min="0" :required="!isQuickCheckMode"></div>
                <div class="form-group"><label for="faceLength">Face Length (<span x-text="inputs.unit"></span>)<span class="asterisk">*</span><div class="tooltip-container" x-data="{ visible: false }"><button type="button" class="tooltip-trigger-btn" @mouseenter="visible = true" @mouseleave="visible = false" @focus="visible = true" @blur="visible = false" aria-describedby="fl-tip"><svg viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.294-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 8.411V6.588zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg></button><div x-show="visible" x-transition.opacity.duration.150ms class="tooltip-popup" id="fl-tip">Hairline to tip of chin.</div></div></label><input type="number" id="faceLength" x-model.number="inputs.faceLength" placeholder="e.g. 19" step="0.1" min="0" required></div>
                <div class="form-group" x-show="!isQuickCheckMode" x-transition.opacity><label for="featureSharpness">Feature Sharpness <span class="asterisk">*</span><div class="tooltip-container" x-data="{ visible: false }"><button type="button" class="tooltip-trigger-btn" @mouseenter="visible = true" @mouseleave="visible = false" @focus="visible = true" @blur="visible = false" aria-describedby="fs-tip"><svg viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.294-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 8.411V6.588zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg></button><div x-show="visible" x-transition.opacity.duration.150ms class="tooltip-popup" id="fs-tip">Sharp or rounded facial features?</div></div></label><select id="featureSharpness" x-model="inputs.featureSharpness" :required="!isQuickCheckMode"><option value="" disabled>Select feature type</option><option value="Sharp">Sharp</option><option value="In the middle">In the middle</option><option value="Round">Round</option></select></div>
                <div class="form-group" x-show="!isQuickCheckMode" x-transition.opacity><label for="preferredStyle">Preferred General Style (Optional)<div class="tooltip-container" x-data="{ visible: false }"><button type="button" class="tooltip-trigger-btn" @mouseenter="visible = true" @mouseleave="visible = false" @focus="visible = true" @blur="visible = false" aria-describedby="ps-tip"><svg viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.294-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 8.411V6.588zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg></button><div x-show="visible" x-transition.opacity.duration.150ms class="tooltip-popup" id="ps-tip">Helps refine style suggestions.</div></div></label><select id="preferredStyle" x-model="inputs.preferredStyle"><option value="">Any Style</option><option value="Classic">Classic</option><option value="Modern">Modern/Trendy</option><option value="Vintage">Vintage</option><option value="Sporty">Sporty</option><option value="Minimalist">Minimalist</option></select></div>
            </div>
            <div x-show="errorMessage" class="error-message" x-text="errorMessage"></div>
            <div class="action-buttons"><button type="button" @click="resetForm()" class="btn btn-secondary">Reset</button><button type="submit" class="btn btn-primary">Calculate Size & Style</button></div>
        </form>

        <!-- Results Section -->
        <div x-show="results.show" class="results-container" x-transition.opacity.duration.300ms>
             <h2>Your <span x-text="isQuickCheckMode ? 'Quick' : ''"></span> Sunglass Recommendations</h2>
            <div class="results-grid"><div class="result-item"><div class="label">Eye Size</div><div class="value"><span x-text="results.eyeSize"></span><span class="unit">mm</span></div></div><div class="result-item"><div class="label">Bridge Width</div><div class="value"><span x-text="results.bridgeWidth"></span><span class="unit">mm</span></div></div><div class="result-item"><div class="label">Temple Length</div><div class="value"><span x-text="results.templeLength"></span><span class="unit">mm</span></div></div></div>
            <div class="results-actions"><button type="button" @click="copyResultsToClipboard()" class="btn btn-copy"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 7a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1H-.5A.5.5 0 0 1-1 7z"/></svg><span x-text="copyButtonText"></span></button></div>
            <div class="face-shape-display"><div class="face-shape-visualizer" x-html="getFaceShapeSVG()"></div><div class="face-shape-info"><h3>Probable Face Shape: <span x-text="results.faceShapeDescription"></span></h3><p x-text="results.faceShapeRecommendation"></p></div></div>
            <div class="suggested-styles-container" x-show="!isQuickCheckMode && results.suggestedStyles.length > 0"><h3>Suggested Sunglass Styles</h3><div class="styles-grid"><template x-for="style in results.suggestedStyles" :key="style.name"><div class="style-card"><div x-html="style.icon" class="style-icon-wrapper"></div><div class="style-name" x-text="style.name"></div><div class="style-reason" x-text="style.reason"></div></div></template></div></div>
            <div class="advanced-tips" x-show="results.advancedTips.length > 0"><h3>Pro Tips</h3><ul><template x-for="tip in results.advancedTips" :key="tip"><li x-text="tip"></li></template></ul></div>
            <p style="font-size: 0.8em; opacity: 0.7; margin-top: 20px; text-align:center;"><em>Disclaimer: These are general recommendations.</em></p>
        </div>

        <!-- Separator -->
        <div class="virtual-tryon-separator"></div>

        <!-- Virtual Try-On Section -->
        <div class="virtual-tryon-container" x-data="virtualTryOnManager">
            <h2>Virtual Try-On</h2>
            <div class="upload-section"><label for="userImageUpload" class="btn btn-upload">Upload Your Photo</label><input type="file" id="userImageUpload" @change="handleImageUpload($event)" accept="image/*"><p x-show="!userImageSrc && !uploadError" style="font-size:0.85em; margin-top:10px; opacity:0.7;">For best results, use a clear, front-facing photo.</p><p x-show="uploadError" x-text="uploadError" style="color: #dc3545; font-size:0.85em; margin-top:10px;"></p></div>
            <div x-show="userImageSrc"><div class="sunglass-style-selector"><h3>Select a Style to Try</h3><template x-for="style in availableSunglassStyles" :key="style.name"><button class="style-preview-btn" :class="{'active': currentOverlaySVGName === style.name}" @click="selectSunglassForTryOn(style.name, style.svg)" :title="'Try on ' + style.name"><div x-html="style.svg"></div></button></template></div>
                <div class="vto-frame-colors"><h4>Frame Color:</h4><template x-for="color in frameColorOptions" :key="color.name"><button class="color-swatch" :style="{ backgroundColor: color.hex }" :class="{ 'active': overlay.frameColor === color.hex }" @click="setFrameColor(color.hex)" :title="color.name"></button></template></div>
                <div class="tryon-area" x-ref="tryonArea"><canvas x-ref="userImageCanvas"></canvas><div class="tryon-svg-overlay" x-show="currentOverlaySVG" :style="{ left: overlay.x + 'px', top: overlay.y + 'px', width: overlay.width + 'px', height: overlay.height + 'px', transform: `rotate(${overlay.rotation}deg) scale(${overlay.scale})`, color: overlay.frameColor }" @mousedown="startDrag" @touchstart.prevent="startDrag" x-html="currentOverlaySVG"></div></div>
                <div class="tryon-controls"><button class="btn btn-secondary btn-sm" @click="overlay.scale = Math.max(0.2, overlay.scale - 0.1)">Zoom Out</button><button class="btn btn-secondary btn-sm" @click="overlay.scale += 0.1">Zoom In</button><button class="btn btn-secondary btn-sm" @click="overlay.rotation -= 5">Rotate Left</button><button class="btn btn-secondary btn-sm" @click="overlay.rotation += 5">Rotate Right</button></div>
                <div class="tryon-main-actions"><button class="btn btn-secondary" @click="resetOverlay">Reset Glasses</button><button class="btn btn-primary" @click="downloadLook" :disabled="downloadingLook" x-text="downloadingLook ? 'Preparing...' : 'Download Look'"></button><button class="btn btn-secondary" @click="removePhoto">Remove Photo</button></div>
            </div>
        </div>
    </div>

    <!-- README Modal -->
    <div class="modal-overlay" :class="{'active': isModalOpen}" @click.self="isModalOpen = false" x-cloak>
        <div class="modal-content" @click.stop>
            <button class="modal-close-btn" @click="isModalOpen = false" title="Close modal"><svg viewBox="0 0 24 24"><path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg></button>
            <h2>How to Use "Sun Glass"</h2><p>Estimate sunglass size, get style suggestions, and use Virtual Try-On.</p><h3>Taking Measurements (Visual Guides)</h3>
            <div class="measurement-guide"><h4>Forehead Width:</h4><svg viewBox="0 0 100 100"><ellipse cx="50" cy="50" rx="40" ry="48" fill="#eee" stroke="#aaa"/><line x1="20" y1="30" x2="80" y2="30" stroke="red" stroke-width="2" stroke-dasharray="4 2"/><text x="50" y="25" font-size="8" text-anchor="middle">Forehead Width</text></svg><p>Widest part of forehead.</p></div>
            <div class="measurement-guide"><h4>Cheeks Width:</h4><svg viewBox="0 0 100 100"><ellipse cx="50" cy="50" rx="40" ry="48" fill="#eee" stroke="#aaa"/><line x1="15" y1="50" x2="85" y2="50" stroke="red" stroke-width="2" stroke-dasharray="4 2"/><circle cx="25" cy="50" r="3" fill="blue"/><circle cx="75" cy="50" r="3" fill="blue"/><text x="50" y="45" font-size="8" text-anchor="middle">Cheeks Width</text></svg><p>Outer corner of eye to outer corner of other eye.</p></div>
            <div class="measurement-guide"><h4>Jawline Length:</h4><svg viewBox="0 0 100 100"><ellipse cx="50" cy="50" rx="40" ry="48" fill="#eee" stroke="#aaa"/><path d="M50 90 Q 20 70, 20 50" stroke="red" stroke-width="2" fill="none"  stroke-dasharray="4 2"/><text x="30" y="75" font-size="8">Jawline (one side)</text></svg><p>Chin to below ear (one side).</p></div>
            <div class="measurement-guide"><h4>Face Length:</h4><svg viewBox="0 0 100 100"><ellipse cx="50" cy="50" rx="40" ry="48" fill="#eee" stroke="#aaa"/><line x1="50" y1="10" x2="50" y2="90" stroke="red" stroke-width="2" stroke-dasharray="4 2"/><text x="55" y="50" font-size="8">Face Length</text></svg><p>Center of hairline to tip of chin.</p></div>
            <p>Ensure tape is snug. Use preferred unit.</p><h3>Sizing & Styling Formula</h3><p>Logic based on general anthropometrics and style heuristics. Provides an <strong>estimation</strong>.</p>
            <p><strong>Disclaimer:</strong> Simplified model. Always try on sunglasses. App for info only.</p>
        </div>
    </div>

<script>
const SUNGATE_STYLE_ICONS = { 
    Default: `<svg class="style-icon" viewBox="0 0 100 50"><rect x="5" y="10" width="35" height="30" rx="5" stroke="currentColor" fill="rgba(30,30,30,0.65)"/><rect x="60" y="10" width="35" height="30" rx="5" stroke="currentColor" fill="rgba(30,30,30,0.65)"/><line x1="40" y1="25" x2="60" y2="25" stroke="currentColor" class="no-fill"/></svg>`,
    Aviator: `<svg class="style-icon" viewBox="0 0 100 50"><path d="M10 20 C5 22, 5 35, 10 40 L35 40 C45 35, 45 22, 35 20 Z" stroke="currentColor" fill="rgba(30,30,30,0.65)"/><path d="M65 20 C55 22, 55 35, 60 40 L85 40 C95 35, 95 22, 85 20 Z" stroke="currentColor" fill="rgba(30,30,30,0.65)"/><line x1="15" y1="15" x2="85" y2="15" stroke="currentColor" stroke-width="3" class="no-fill"/><line x1="42" y1="28" x2="58" y2="28" stroke="currentColor" stroke-width="3" class="no-fill"/></svg>`,
    Wayfarer: `<svg class="style-icon" viewBox="0 0 100 50"><path d="M5 10 H40 L45 25 L40 40 H5 Z" stroke="currentColor" fill="rgba(30,30,30,0.65)"/> <path d="M55 10 H90 L95 25 L90 40 H55 Z" stroke="currentColor" fill="rgba(30,30,30,0.65)"/> <line x1="45" y1="20" x2="55" y2="20" stroke="currentColor" class="no-fill"/></svg>`,
    Round: `<svg class="style-icon" viewBox="0 0 100 50"><circle cx="25" cy="25" r="18" stroke="currentColor" fill="rgba(30,30,30,0.65)"/><circle cx="75" cy="25" r="18" stroke="currentColor" fill="rgba(30,30,30,0.65)"/><line x1="43" y1="25" x2="57" y2="25" stroke="currentColor" class="no-fill"/></svg>`,
    Square: `<svg class="style-icon" viewBox="0 0 100 50"><rect x="7" y="7" width="36" height="36" rx="3" stroke="currentColor" fill="rgba(30,30,30,0.65)"/><rect x="57" y="7" width="36" height="36" rx="3" stroke="currentColor" fill="rgba(30,30,30,0.65)"/><line x1="43" y1="25" x2="57" y2="25" stroke="currentColor" class="no-fill"/></svg>`,
    CatEye: `<svg class="style-icon" viewBox="0 0 100 50"><path d="M5 25 Q20 5 45 15 L40 40 Q20 45 5 35 Z" stroke="currentColor" fill="rgba(30,30,30,0.65)"/> <path d="M55 15 Q80 5 95 25 L90 35 Q80 45 60 40 Z" stroke="currentColor" fill="rgba(30,30,30,0.65)"/> <line x1="45" y1="20" x2="55" y2="20" stroke="currentColor" class="no-fill"/></svg>`,
};
const VIRTUAL_TRYON_SVGS = JSON.parse(JSON.stringify(SUNGATE_STYLE_ICONS));
for (const key in VIRTUAL_TRYON_SVGS) { VIRTUAL_TRYON_SVGS[key] = VIRTUAL_TRYON_SVGS[key].replace('class="style-icon"','class="tryon-overlay-svg"'); }

function sunGlassApp() {
    return {
        isDarkMode: false, isModalOpen: false, isQuickCheckMode: false, errorMessage: '', copyButtonText: 'Copy Results',
        inputs: { sex: '', foreheadWidth: null, cheeksWidth: null, jawlineLength: null, faceLength: null, featureSharpness: '', unit: 'cm', preferredStyle: '' },
        results: { show: false, eyeSize: 0, bridgeWidth: 0, templeLength: 0, faceShapeDescription: '', faceShapeRecommendation: '', advancedTips: [], suggestedStyles: [] },
        initApp() {
            const storedTheme = localStorage.getItem('sunGlassTheme');
            if (storedTheme) this.isDarkMode = storedTheme === 'dark'; else this.isDarkMode = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
            const storedMode = localStorage.getItem('sunGlassMode');
            if (storedMode) this.isQuickCheckMode = storedMode === 'quick';
            this.$watch('isQuickCheckMode', (value) => localStorage.setItem('sunGlassMode', value ? 'quick' : 'standard'));
        },
        toggleTheme() { this.isDarkMode = !this.isDarkMode; localStorage.setItem('sunGlassTheme', this.isDarkMode ? 'dark' : 'light'); },
        validateInputs() {
            this.errorMessage = ''; const baseRequiredFields = ['sex', 'cheeksWidth', 'faceLength']; const standardOnlyFields = ['foreheadWidth', 'jawlineLength', 'featureSharpness']; let fieldsToValidate = [...baseRequiredFields];
            if (!this.isQuickCheckMode) fieldsToValidate.push(...standardOnlyFields);
            for (const field of fieldsToValidate) { if (!this.inputs[field] && this.inputs[field] !== 0) { this.errorMessage = `Missing: ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`; this.results.show = false; return false; } }
            const numericFields = ['cheeksWidth', 'faceLength']; if (!this.isQuickCheckMode) numericFields.push('foreheadWidth', 'jawlineLength');
            for (const field of numericFields) { if (typeof this.inputs[field] !== 'number' || this.inputs[field] <= 0) { this.errorMessage = `Invalid number for ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}.`; this.results.show = false; return false; }
                const maxVal = this.inputs.unit === 'cm' ? 50 : 20, minVal = this.inputs.unit === 'cm' ? 5 : 2;
                if (this.inputs[field] > maxVal) { this.errorMessage = `${field.replace(/([A-Z])/g, ' $1')} too large. Max: ${maxVal} ${this.inputs.unit}.`; this.results.show = false; return false; }
                if (this.inputs[field] < minVal) { this.errorMessage = `${field.replace(/([A-Z])/g, ' $1')} too small. Min: ${minVal} ${this.inputs.unit}.`; this.results.show = false; return false; }
            } return true;
        },
        calculateAndDisplayResults() {
            if (!this.validateInputs()) return; this.copyButtonText = 'Copy Results'; this.results.suggestedStyles = [];
            const toMM = (val, unit) => val && unit ? (unit === 'in' ? val * 25.4 : val * 10) : 0;
            const cw_mm = toMM(this.inputs.cheeksWidth, this.inputs.unit), fl_mm = toMM(this.inputs.faceLength, this.inputs.unit);
            let fw_mm = 0, jl_mm = 0, featureSharpness = this.inputs.featureSharpness, preferredStyle = this.inputs.preferredStyle;
            if (!this.isQuickCheckMode) { fw_mm = toMM(this.inputs.foreheadWidth, this.inputs.unit); jl_mm = toMM(this.inputs.jawlineLength, this.inputs.unit) * 2; }
            else { fw_mm = cw_mm * 0.9; jl_mm = cw_mm * 0.8; featureSharpness = 'In the middle'; preferredStyle = ''; }
            let faceShape = "Oval", recommendation = "Oval faces are versatile. Experiment!"; const lengthToCheekRatio = fl_mm / cw_mm;
            if (this.isQuickCheckMode) { if (lengthToCheekRatio > 1.3) faceShape = "Oblong/Rectangle"; else if (Math.abs(fl_mm - cw_mm) < (0.15 * cw_mm)) faceShape = "Round/Square"; recommendation = `${faceShape} faces: Styles that ${faceShape === "Oblong/Rectangle" ? "add width" : "contrast shape"}.`; }
            else { if (lengthToCheekRatio > 1.3 && Math.abs(fw_mm - cw_mm) < (0.15 * cw_mm) && Math.abs(cw_mm - jl_mm) < (0.15 * cw_mm)) { faceShape = "Oblong"; recommendation = "Taller frames add width.";} else if (Math.abs(fl_mm - cw_mm) < (0.1 * cw_mm) && cw_mm > fw_mm && featureSharpness === 'Round') { faceShape = "Round"; recommendation = "Angular frames add definition.";} else if (Math.abs(fl_mm - cw_mm) < (0.1 * cw_mm) && Math.abs(fw_mm - cw_mm) < (0.1 * cw_mm) && Math.abs(cw_mm - jl_mm) < (0.1 * cw_mm) && featureSharpness === 'Sharp') { faceShape = "Square"; recommendation = "Round/oval frames soften angles.";} else if (fw_mm > jl_mm && cw_mm > jl_mm && fw_mm > cw_mm * 0.9 && (featureSharpness === 'Sharp' || featureSharpness === 'In the middle')) { faceShape = "Heart"; recommendation = "Frames wider at bottom (Aviators, Cat-Eyes).";} else if (cw_mm > fw_mm && cw_mm > jl_mm && featureSharpness === 'Sharp') { faceShape = "Diamond"; recommendation = "Rimless, oval, or cat-eye shapes.";} }
            this.results.faceShapeDescription = faceShape; this.results.faceShapeRecommendation = recommendation;
            let eyeSize = Math.round(cw_mm * (this.isQuickCheckMode ? 0.30 : 0.32)); if (this.inputs.sex === 'Male' && eyeSize < 48) eyeSize = Math.max(eyeSize, 48); if (this.inputs.sex === 'Female' && eyeSize < 46) eyeSize = Math.max(eyeSize, 46); if (eyeSize > 62) eyeSize = 62; this.results.eyeSize = Math.round(eyeSize);
            let bridgeWidth = 18; if (!this.isQuickCheckMode && fw_mm > 0) { if (fw_mm / cw_mm > 1.05) bridgeWidth -=2; if (fw_mm / cw_mm < 0.95) bridgeWidth +=2; if (featureSharpness === 'Round') bridgeWidth +=1;} this.results.bridgeWidth = Math.max(14, Math.min(24, Math.round(bridgeWidth)));
            let templeLength = 140; if (fl_mm > 200 || (this.inputs.sex === 'Male' && fl_mm > 190) ) templeLength = 145; if (fl_mm > 220 || (this.inputs.sex === 'Male' && fl_mm > 210) ) templeLength = 150; if (fl_mm < 180 || (this.inputs.sex === 'Female' && fl_mm < 170)) templeLength = 135; if (!this.isQuickCheckMode && jl_mm > 0 && toMM(this.inputs.jawlineLength, this.inputs.unit) > 130) templeLength = Math.max(templeLength, 145);
            if (templeLength <= 137) this.results.templeLength = 135; else if (templeLength <= 142) this.results.templeLength = 140; else if (templeLength <= 147) this.results.templeLength = 145; else this.results.templeLength = 150;
            if (!this.isQuickCheckMode) {
                let suggested = []; const baseStyles = { "Oval": [{n:"Wayfarer", r:"Classic balance"}, {n:"Aviator", r:"Complements"}, {n:"Round", r:"Soft, stylish"}], "Round": [{n:"Square", r:"Adds definition"}, {n:"Wayfarer", r:"Angular contrast"}, {n:"Geometric", r:"Modern"}], "Square": [{n:"Round", r:"Softens angles"}, {n:"Aviator", r:"Curved lines"}, {n:"CatEye", r:"Lifts features"}], "Oblong": [{n:"Wayfarer", r:"Adds width"}, {n:"Square", r:"Balances"}, {n:"Aviator", r:"Breaks vertical"}], "Heart": [{n:"Aviator", r:"Balances jaw"}, {n:"CatEye", r:"Wider top"}, {n:"Round", r:"Softens forehead"}], "Diamond": [{n:"CatEye", r:"Highlights eyes"}, {n:"Oval", r:"Softens"}, {n:"Clubmaster", r:"Accentuates brow"}] };
                let primarySuggestions = baseStyles[faceShape] || baseStyles["Oval"];
                if (preferredStyle) { const styleFilters = { "Classic": ["Wayfarer", "Clubmaster", "Aviator", "Round"], "Modern": ["Geometric", "Square", "CatEye", "Sport"], "Vintage": ["Round", "CatEye", "Clubmaster", "Aviator"], "Sporty": ["Sport", "Aviator"], "Minimalist": ["Round", "Square"] };
                    const filteredByPref = primarySuggestions.filter(s => styleFilters[preferredStyle]?.includes(s.n));
                    if (filteredByPref.length > 0) { suggested = filteredByPref; if (suggested.length < 2) { styleFilters[preferredStyle]?.forEach(styleName => { if (suggested.length < 3 && !suggested.find(s => s.n === styleName)) { const baseReason = primarySuggestions.find(ps => ps.n === styleName)?.r || "Good for preference"; suggested.push({n: styleName, r: baseReason }); } }); } }
                    else { suggested = primarySuggestions; }
                } else { suggested = primarySuggestions; }
                const uniqueNames = new Set(); this.results.suggestedStyles = suggested.filter(style => { if (!uniqueNames.has(style.n) && uniqueNames.size < 3) { uniqueNames.add(style.n); return true; } return false; }).map(s => ({ name: s.n, reason: s.r, icon: SUNGATE_STYLE_ICONS[s.n] || SUNGATE_STYLE_ICONS.Default }));
            }
            this.results.advancedTips = []; if (this.results.eyeSize >= 55) this.results.advancedTips.push("Larger eye size? Oversized frames can be great."); if (this.results.bridgeWidth <= 16) this.results.advancedTips.push("Narrow bridge? Look for adjustable nose pads or keyhole designs.");
            this.results.show = true; if (window.innerWidth < 768) { this.$nextTick(() => { document.querySelector('.results-container')?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }); }
        },
        getFaceShapeSVG() { const strokeColor = getComputedStyle(document.documentElement).getPropertyValue(this.isDarkMode ? '--color-primary' : '--color-primary').trim(); const commonAttrs = `stroke="${strokeColor}" stroke-width="6" fill="none"`; switch (this.results.faceShapeDescription.toLowerCase().split('/')[0]) { case 'oval': return `<svg viewBox="0 0 100 120"><ellipse cx="50" cy="60" rx="40" ry="55" ${commonAttrs}/></svg>`; case 'round': return `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" ${commonAttrs}/></svg>`; case 'square': return `<svg viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" rx="5" ${commonAttrs}/></svg>`; case 'oblong': return `<svg viewBox="0 0 100 130"><rect x="15" y="10" width="70" height="110" rx="10" ${commonAttrs}/></svg>`; case 'heart': return `<svg viewBox="0 0 100 100"><path d="M50,15 Q15,15 10,50 Q25,90 50,95 Q75,90 90,50 Q85,15 50,15 Z" ${commonAttrs}/></svg>`; case 'diamond': return `<svg viewBox="0 0 100 100"><polygon points="50,5 95,50 50,95 5,50" ${commonAttrs}/></svg>`; default: return `<svg viewBox="0 0 100 120"><ellipse cx="50" cy="60" rx="40" ry="55" ${commonAttrs} stroke-dasharray="5,5" /></svg>`; } },
        copyResultsToClipboard() { const textToCopy = `Sizes:\nEye: ${this.results.eyeSize}mm\nBridge: ${this.results.bridgeWidth}mm\nTemple: ${this.results.templeLength}mm\nShape: ${this.results.faceShapeDescription}`; navigator.clipboard.writeText(textToCopy).then(() => { this.copyButtonText = 'Copied!'; setTimeout(() => { this.copyButtonText = 'Copy Results'; }, 2000); }).catch(err => { this.copyButtonText = 'Copy Failed'; setTimeout(() => { this.copyButtonText = 'Copy Results'; }, 2000); }); },
        resetForm() { this.inputs = { sex: '', foreheadWidth: null, cheeksWidth: null, jawlineLength: null, faceLength: null, featureSharpness: '', unit: this.inputs.unit, preferredStyle: '' }; this.results.show = false; this.errorMessage = ''; this.copyButtonText = 'Copy Results'; this.results.advancedTips = []; this.results.suggestedStyles = []; }
    };
}

document.addEventListener('alpine:init', () => {
    Alpine.data('virtualTryOnManager', () => ({
        userImageSrc: null, uploadError: '', currentOverlaySVG: '', currentOverlaySVGName: '', canvasEl: null, canvasCtx: null,
        overlay: { x: 50, y: 50, width: 150, height: 75, scale: 1, rotation: 0, frameColor: '#333333' },
        isDragging: false, dragStartX: 0, dragStartY: 0, initialOverlayX: 0, initialOverlayY: 0,
        downloadingLook: false,
        availableSunglassStyles: Object.entries(VIRTUAL_TRYON_SVGS).map(([name, svg]) => ({ name, svg })),
        frameColorOptions: [ { name: 'Black', hex: '#333333' }, { name: 'Tortoise', hex: '#654321' }, { name: 'Silver', hex: '#C0C0C0' }, { name: 'Gold', hex: '#FFD700' }, { name: 'Blue', hex: '#007bff' } ],
        init() {
            this.canvasEl = this.$refs.userImageCanvas;
            const stopDragHandler = () => this.stopDrag(); const dragHandler = (e) => this.drag(e);
            window.addEventListener('mouseup', stopDragHandler); window.addEventListener('touchend', stopDragHandler);
            window.addEventListener('mousemove', dragHandler); window.addEventListener('touchmove', dragHandler, {passive: false});
            this.$watch('userImageSrc', () => { if(this.userImageSrc) this.$nextTick(() => this.drawImageToCanvas()); });
        },
        handleImageUpload(event) {
            this.uploadError = ''; const file = event.target.files[0]; if (!file) return;
            if (!file.type.startsWith('image/')) { this.uploadError = 'Please upload a valid image file.'; event.target.value = null; return; }
            if (file.size > 5 * 1024 * 1024) { this.uploadError = 'Image size too large (max 5MB).'; event.target.value = null; return; }
            const reader = new FileReader(); reader.onload = (e) => { this.userImageSrc = e.target.result; }; 
            reader.onerror = () => { this.uploadError = 'Error reading file.'; event.target.value = null; }
            reader.readAsDataURL(file);
        },
        removePhoto() { this.userImageSrc = null; this.currentOverlaySVG = ''; this.currentOverlaySVGName = ''; if (this.canvasCtx) this.canvasCtx.clearRect(0, 0, this.canvasEl.width, this.canvasEl.height); document.getElementById('userImageUpload').value = null; this.uploadError = ''; },
        drawImageToCanvas() {
            if (!this.userImageSrc || !this.canvasEl) return; this.canvasCtx = this.canvasEl.getContext('2d'); const img = new Image();
            img.onload = () => {
                const tryonAreaWidth = this.$refs.tryonArea.offsetWidth; const aspectRatio = img.width / img.height;
                this.canvasEl.width = tryonAreaWidth; this.canvasEl.height = tryonAreaWidth / aspectRatio;
                this.canvasCtx.clearRect(0, 0, this.canvasEl.width, this.canvasEl.height); this.canvasCtx.drawImage(img, 0, 0, this.canvasEl.width, this.canvasEl.height);
                if (!this.currentOverlaySVG && this.availableSunglassStyles.length > 0) { this.selectSunglassForTryOn(this.availableSunglassStyles[0].name, this.availableSunglassStyles[0].svg); } else {this.resetOverlay();}
            }; img.src = this.userImageSrc;
        },
        selectSunglassForTryOn(name, svgString) {
            this.currentOverlaySVGName = name; let processedSVG = svgString.replace('class="style-icon"','class="tryon-overlay-svg"');
            if (!processedSVG.includes('viewBox')) { processedSVG = processedSVG.replace('<svg', '<svg viewBox="0 0 100 50"'); } this.currentOverlaySVG = processedSVG;
            const viewBoxMatch = processedSVG.match(/viewBox="([\d\s\.]+)"/); let initialWidth = 150, initialHeight = 75; 
            if (viewBoxMatch) { const vb = viewBoxMatch[1].split(" ").map(Number); if (vb.length === 4 && vb[2] > 0 && vb[3] > 0) { const svgAspectRatio = vb[2] / vb[3]; initialHeight = initialWidth / svgAspectRatio; } }
            this.overlay.width = initialWidth; this.overlay.height = initialHeight; this.resetOverlay();
        },
        setFrameColor(colorHex) { this.overlay.frameColor = colorHex; },
        resetOverlay() {
            if (this.canvasEl && this.canvasEl.width > 0) { this.overlay.x = (this.canvasEl.width - this.overlay.width) / 2; this.overlay.y = (this.canvasEl.height / 2.5) - (this.overlay.height / 2) ; }
            else { this.overlay.x = 50; this.overlay.y = 30; } this.overlay.scale = 1; this.overlay.rotation = 0;
        },
        startDrag(event) {
            if (event.target.closest('.tryon-controls button, .tryon-main-actions button, .vto-frame-colors button')) return; this.isDragging = true;
            const clientX = event.touches ? event.touches[0].clientX : event.clientX; const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            const overlayRect = event.currentTarget.getBoundingClientRect(); this.dragStartX = clientX - overlayRect.left; this.dragStartY = clientY - overlayRect.top;
            this.initialOverlayX = this.overlay.x; this.initialOverlayY = this.overlay.y; if (event.touches) event.preventDefault();
        },
        drag(event) {
            if (!this.isDragging) return; const clientX = event.touches ? event.touches[0].clientX : event.clientX; const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            const tryonAreaRect = this.$refs.tryonArea.getBoundingClientRect(); const mouseXInTryonArea = clientX - tryonAreaRect.left; const mouseYInTryonArea = clientY - tryonAreaRect.top;
            let newX = mouseXInTryonArea - this.dragStartX; let newY = mouseYInTryonArea - this.dragStartY;
            const scaledWidth = this.overlay.width * this.overlay.scale; const scaledHeight = this.overlay.height * this.overlay.scale;
            const constrainMarginX = scaledWidth * 0.75; const constrainMarginY = scaledHeight * 0.75;
            if (this.canvasEl) { newX = Math.max(-constrainMarginX, Math.min(newX, this.canvasEl.width - scaledWidth + constrainMarginX)); newY = Math.max(-constrainMarginY, Math.min(newY, this.canvasEl.height - scaledHeight + constrainMarginY)); }
            this.overlay.x = newX; this.overlay.y = newY; if (event.touches) event.preventDefault();
        },
        stopDrag() { this.isDragging = false; },
        downloadLook() {
            if (!this.canvasEl || !this.userImageSrc || !this.currentOverlaySVG || this.downloadingLook) return;
            this.downloadingLook = true;
            const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = this.canvasEl.width; tempCanvas.height = this.canvasEl.height;
            tempCtx.drawImage(this.canvasEl, 0, 0);
            const svgImage = new Image();
            const overlayDiv = document.createElement('div'); overlayDiv.style.color = this.overlay.frameColor; overlayDiv.innerHTML = this.currentOverlaySVG; const svgElement = overlayDiv.firstChild;
            const serializer = new XMLSerializer(); const svgStringWithColor = serializer.serializeToString(svgElement);
            svgImage.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgStringWithColor)));
            svgImage.onload = () => {
                tempCtx.save();
                // Translate to the top-left of the overlay's intended position
                tempCtx.translate(this.overlay.x, this.overlay.y);
                // Translate to the center of the unscaled overlay for rotation/scaling origin
                tempCtx.translate(this.overlay.width / 2, this.overlay.height / 2);
                tempCtx.rotate(this.overlay.rotation * Math.PI / 180);
                tempCtx.scale(this.overlay.scale, this.overlay.scale);
                // Draw the SVG centered at this new (0,0) origin
                tempCtx.drawImage(svgImage, -this.overlay.width / 2, -this.overlay.height / 2, this.overlay.width, this.overlay.height);
                tempCtx.restore();
                const link = document.createElement('a'); link.download = 'my-sunglass-look.png'; link.href = tempCanvas.toDataURL('image/png');
                link.click(); this.downloadingLook = false;
            };
            svgImage.onerror = () => { console.error("Error loading SVG for download."); alert("Sorry, an error occurred preparing download."); this.downloadingLook = false; }
        }
    }));
});
</script>
</body>
</html>