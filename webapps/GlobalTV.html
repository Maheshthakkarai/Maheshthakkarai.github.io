<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Global TV</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'>ðŸ“º</text%3E%3C/svg%3E">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a90e2; --secondary-color: #1d2a38; --text-color: #e0e0e0;
            --text-color-muted: rgba(224, 224, 224, 0.7); --bg-color: #131b24;
            --card-bg: rgba(255, 255, 255, 0.05); --card-hover-bg: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.2); --input-bg: rgba(0, 0, 0, 0.2);
            --border-radius: 8px; --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            --font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --failed-color: #909090; --active-color: #58c4ff; --favorite-color: #f1c40f;
            --progress-bar-bg: rgba(255, 255, 255, 0.2);
            --select-arrow-icon: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23cccccc%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
        }
        body.light-theme {
            --primary-color: #3478c7; --secondary-color: #ffffff; --text-color: #2c3e50;
            --text-color-muted: rgba(44, 62, 80, 0.7); --bg-color: #f0f2f5;
            --card-bg: rgba(255, 255, 255, 0.8); --card-hover-bg: rgba(245, 245, 245, 1);
            --border-color: rgba(0, 0, 0, 0.15); --input-bg: #f9f9f9;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); --progress-bar-bg: rgba(0, 0, 0, 0.1);
            --select-arrow-icon: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
        }
        html { box-sizing: border-box; font-size: 16px; scroll-behavior: smooth; }
        *, *:before, *:after { box-sizing: inherit; }
        body { font-family: var(--font-family); line-height: 1.6; background: linear-gradient(to bottom, var(--secondary-color), var(--bg-color)); color: var(--text-color); margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; transition: background 0.3s, color 0.3s; }
        .container { max-width: 900px; margin: 1rem auto; padding: 1.5rem; background-color: rgba(0,0,0,0.1); border-radius: var(--border-radius); box-shadow: var(--box-shadow); display: flex; flex-direction: column; flex: 1; overflow: hidden; border: 1px solid var(--border-color); }
        .header { display: flex; justify-content: center; align-items: center; position: relative; }
        h1 { text-align: center; margin:0 auto; font-weight: 600; color: var(--primary-color); }
        .header-icons { position: absolute; right: 0; top: 50%; transform: translateY(-50%); display:flex; gap: 1rem; color: var(--text-color-muted); }
        .header-icons i { cursor: pointer; font-size: 1.2rem; transition: color 0.2s; }
        .header-icons i:hover { color: var(--primary-color); }
        #playlistSettings { background: var(--card-bg); border: 1px solid var(--border-color); padding: 1rem; margin-bottom: 1rem; border-radius: var(--border-radius); }
        .playlist-buttons { display: flex; gap: 0.5rem; }
        .playlist-buttons button { flex-grow: 1; padding: 0.5rem; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s; }
        .playlist-buttons .load-btn { background-color: var(--primary-color); color: white; }
        .playlist-buttons .default-btn { background-color: var(--input-bg); color: var(--text-color); }
        .disclaimer { text-align: center; font-size: 0.85rem; color: var(--text-color-muted); margin-bottom: 1rem; }
        .controls-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        select, input[type="text"] { width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--input-bg); color: var(--text-color); font-size: 1rem; transition: border-color 0.2s ease, background-color 0.2s ease; }
        select:focus, input[type="text"]:focus { outline: none; border-color: var(--primary-color); }
        select { appearance: none; background-image: var(--select-arrow-icon); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 2.5em; }
        select option { background: var(--secondary-color); color: var(--text-color); }
        .channel-list-container { margin-bottom: 1.5rem; flex-shrink: 1; display: flex; flex-direction: column; min-height: 150px; max-height: 55vh; overflow: hidden; }
        #channelList { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #channelList.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        .channel-item { display: flex; align-items: center; background-color: var(--card-bg); border-radius: var(--border-radius); border-left: 4px solid transparent; cursor: pointer; transition: all 0.2s ease; overflow: hidden; animation: fadeIn 0.4s ease-out forwards; }
        #channelList.list-view .channel-item { padding: 0.7rem 1rem; margin-bottom: 0.5rem; gap: 1rem; }
        #channelList.grid-view .channel-item { flex-direction: column; padding: 1rem; text-align: center; gap: 0.5rem; align-items: stretch; border-left: none; border-bottom: 4px solid transparent; }
        .channel-item:not(.failed-channel):hover { background-color: var(--card-hover-bg); transform: translateY(-1px); }
        .channel-details { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .channel-info { display: flex; align-items: center; overflow: hidden; }
        #channelList.list-view .channel-info { gap: 1rem; }
        #channelList.grid-view .channel-info { flex-direction: column; gap: 0.75rem; }
        .channel-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        #channelList.grid-view .channel-name { white-space: normal; text-align: center; font-weight: 600; min-height: 2.4em; }
        .channel-logo { width: 36px; height: 36px; object-fit: contain; border-radius: 4px; background-color: rgba(0,0,0,0.1); flex-shrink: 0; border: 1px solid var(--border-color); }
        #channelList.grid-view .channel-logo { width: 80px; height: 80px; margin: 0 auto; }
        .channel-actions { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
        #channelList.grid-view .channel-actions { justify-content: space-around; padding-top: 0.5rem; }
        .favorite-icon { font-size: 1.1em; color: var(--text-color-muted); cursor: pointer; transition: color 0.2s ease, transform 0.15s ease; }
        .favorite-icon:hover { transform: scale(1.2); }
        .channel-item.favorited .favorite-icon { color: var(--favorite-color); font-weight: 900; }
        .play-icon { font-size: 1.3em; color: var(--primary-color); transition: color 0.2s ease; }
        .channel-item:not(.failed-channel):hover .play-icon { color: var(--text-color); }
        .channel-item.active-channel { border-color: var(--active-color); }
        .channel-item.failed-channel { border-color: var(--failed-color) !important; color: var(--failed-color); cursor: not-allowed; opacity: 0.7; }
        .channel-item.failed-channel .channel-actions { display: none; }
        .epg-info { margin-top: 0.3rem; font-size: 0.85rem; color: var(--text-color-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .epg-program { cursor: help; }
        .epg-progress-bar { height: 3px; background-color: var(--progress-bar-bg); border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .epg-progress { height: 100%; background-color: var(--primary-color); width: 0%; transition: width 0.5s ease; }
        .video-container { background-color: #000; border-radius: var(--border-radius); margin-top: auto; flex-shrink: 0; scroll-margin-top: 1rem; }
        video { display: block; width: 100%; max-height: 60vh; min-height: 200px; border-radius: var(--border-radius); background-color: #000; }
        .footer-container { padding: 0.6rem 1.5rem; background-color: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1rem; }
        .footer-actions, .footer-right { display: flex; align-items: center; gap: 1rem; }
        .footer-actions button, .footer-right button { background-color: transparent; color: var(--text-color); border: none; cursor: pointer; transition: all 0.2s; font-size: 1.2rem; padding: 0.4rem 0.6rem; border-radius: var(--border-radius); }
        .footer-actions button:hover, .footer-right button:hover { background-color: var(--card-hover-bg); }
        #stopButton { background-color: #e74c3c; color: white; padding: 0.5rem 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.4rem; }
        #stopButton:hover { background-color: #c0392b; }
        #nowPlaying { flex-grow: 1; text-align: center; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color-muted); }
        .loading-indicator { text-align: center; padding: 2rem 0; color: var(--text-color-muted); }
        .spinner { border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 0.8rem; }
        #scroll-sentinel { height: 50px; width: 100%; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .container, .channel-item, select, input, .footer-container, #playlistSettings { -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1><i class="fas fa-tv"></i> My Global TV</h1>
        <div class="header-icons">
            <i id="layoutToggle" class="fas fa-th-large" title="Toggle Layout"></i>
            <i id="settingsToggle" class="fas fa-cog" title="Playlist Settings"></i>
        </div>
    </div>
    
    <div id="playlistSettings" class="hidden">
        <label for="playlistUrlInput">Custom Playlist URL (.m3u)</label>
        <input type="text" id="playlistUrlInput" placeholder="Enter .m3u playlist URL here...">
        <div class="playlist-buttons">
            <button id="loadCustomPlaylist" class="load-btn">Load</button>
            <button id="loadDefaultPlaylist" class="default-btn">Load Default</button>
        </div>
    </div>

    <p class="disclaimer">Note: Playback depends on channel availability and your location.</p>

    <div id="loading-indicator" class="loading-indicator hidden">
        <div class="spinner"></div>
        <span>Loading channels...</span>
    </div>

    <div class="controls-row">
        <div id="country-filter-container" class="hidden"><label for="countrySelect">Filter by Country:</label><select id="countrySelect"></select></div>
        <div><label for="categorySelect">Filter by Category:</label><select id="categorySelect"></select></div>
        <div><label for="channelSearch">Search Channels:</label><input type="text" id="channelSearch" placeholder="Enter channel name..."></div>
    </div>

    <div class="channel-list-container">
        <h3>Available Channels</h3>
        <ul id="channelList" class="list-view"></ul>
        <div id="scroll-sentinel"></div>
    </div>

    <div id="videoContainer" class="video-container hidden"><video id="videoPlayer" controls controlsList="nodownload"></video></div>
</div>

<footer class="footer-container">
    <div class="footer-actions">
        <button id="stopButton" title="Stop Playback"><i class="fas fa-stop"></i> Stop</button>
        <button id="pipButton" class="hidden" title="Picture-in-Picture"><i class="fas fa-clone"></i></button>
    </div>
    <span id="nowPlaying"></span>
    <div class="footer-right">
        <div id="error-message"></div>
        <button id="themeToggle" title="Toggle Theme"><i class="fas fa-moon"></i></button>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    const DEFAULT_PLAYLIST_URL = 'https://iptv-org.github.io/iptv/index.m3u';
    const CHANNELS_METADATA_URL = 'https://iptv-org.github.io/api/channels.json';
    const STORAGE_KEYS = { FAILED_CHANNELS: 'gtv_failed', FAVORITES: 'gtv_favorites', THEME: 'gtv_theme', CUSTOM_URL: 'gtv_custom_url', LAYOUT: 'gtv_layout' };
    const SEARCH_DEBOUNCE_MS = 300;
    const UNKNOWN_VALUE = 'Uncategorized';
    const FAVORITES_CATEGORY_VALUE = 'FAV';
    const CHUNK_SIZE = 40;
    const COUNTRY_CODES = {"AF":"Afghanistan","AX":"Ã…land Islands","AL":"Albania","DZ":"Algeria","AS":"American Samoa","AD":"Andorra","AO":"Angola","AI":"Anguilla","AQ":"Antarctica","AG":"Antigua and Barbuda","AR":"Argentina","AM":"Armenia","AW":"Aruba","AU":"Australia","AT":"Austria","AZ":"Azerbaijan","BS":"Bahamas","BH":"Bahrain","BD":"Bangladesh","BB":"Barbados","BY":"Belarus","BE":"Belgium","BZ":"Belize","BJ":"Benin","BM":"Bermuda","BT":"Bhutan","BO":"Bolivia","BQ":"Bonaire, Sint Eustatius and Saba","BA":"Bosnia and Herzegovina","BW":"Botswana","BV":"Bouvet Island","BR":"Brazil","IO":"British Indian Ocean Territory","BN":"Brunei Darussalam","BG":"Bulgaria","BF":"Burkina Faso","BI":"Burundi","CV":"Cabo Verde","KH":"Cambodia","CM":"Cameroon","CA":"Canada","KY":"Cayman Islands","CF":"Central African Republic","TD":"Chad","CL":"Chile","CN":"China","CX":"Christmas Island","CC":"Cocos (Keeling) Islands","CO":"Colombia","KM":"Comoros","CG":"Congo","CD":"Congo, the Democratic Republic of the","CK":"Cook Islands","CR":"Costa Rica","CI":"CÃ´te d'Ivoire","HR":"Croatia","CU":"Cuba","CW":"CuraÃ§ao","CY":"Cyprus","CZ":"Czech Republic","DK":"Denmark","DJ":"Djibouti","DM":"Dominica","DO":"Dominican Republic","EC":"Ecuador","EG":"Egypt","SV":"El Salvador","GQ":"Equatorial Guinea","ER":"Eritrea","EE":"Estonia","SZ":"Eswatini","ET":"Ethiopia","FK":"Falkland Islands (Malvinas)","FO":"Faroe Islands","FJ":"Fiji","FI":"Finland","FR":"France","GF":"French Guiana","PF":"French Polynesia","TF":"French Southern Territories","GA":"Gabon","GM":"Gambia","GE":"Georgia","DE":"Germany","GH":"Ghana","GI":"Gibraltar","GR":"Greece","GL":"Greenland","GD":"Grenada","GP":"Guadeloupe","GU":"Guam","GT":"Guatemala","GG":"Guernsey","GN":"Guinea","GW":"Guinea-Bissau","GY":"Guyana","HT":"Haiti","HM":"Heard Island and McDonald Islands","VA":"Holy See","HN":"Honduras","HK":"Hong Kong","HU":"Hungary","IS":"Iceland","IN":"India","ID":"Indonesia","IR":"Iran","IQ":"Iraq","IE":"Ireland","IM":"Isle of Man","IL":"Israel","IT":"Italy","JM":"Jamaica","JP":"Japan","JE":"Jersey","JO":"Jordan","KZ":"Kazakhstan","KE":"Kenya","KI":"Kiribati","KP":"North Korea","KR":"South Korea","KW":"Kuwait","KG":"Kyrgyzstan","LA":"Lao People's Democratic Republic","LV":"Latvia","LB":"Lebanon","LS":"Lesotho","LR":"Liberia","LY":"Libya","LI":"Liechtenstein","LT":"Lithuania","LU":"Luxembourg","MO":"Macao","MG":"Madagascar","MW":"Malawi","MY":"Malaysia","MV":"Maldives","ML":"Mali","MT":"Malta","MH":"Marshall Islands","MQ":"Martinique","MR":"Mauritania","MU":"Mauritius","YT":"Mayotte","MX":"Mexico","FM":"Micronesia","MD":"Moldova","MC":"Monaco","MN":"Mongolia","ME":"Montenegro","MS":"Montserrat","MA":"Morocco","MZ":"Mozambique","MM":"Myanmar","NA":"Namibia","NR":"Nauru","NP":"Nepal","NL":"Netherlands","NC":"New Caledonia","NZ":"New Zealand","NI":"Nicaragua","NE":"Niger","NG":"Nigeria","NU":"Niue","NF":"Norfolk Island","MK":"North Macedonia","MP":"Northern Mariana Islands","NO":"Norway","OM":"Oman","PK":"Pakistan","PW":"Palau","PS":"Palestine, State of","PA":"Panama","PG":"Papua New Guinea","PY":"Paraguay","PE":"Peru","PH":"Philippines","PN":"Pitcairn","PL":"Poland","PT":"Portugal","PR":"Puerto Rico","QA":"Qatar","RE":"RÃ©union","RO":"Romania","RU":"Russia","RW":"Rwanda","BL":"Saint BarthÃ©lemy","SH":"Saint Helena, Ascension and Tristan da Cunha","KN":"Saint Kitts and Nevis","LC":"Saint Lucia","MF":"Saint Martin (French part)","PM":"Saint Pierre and Miquelon","VC":"Saint Vincent and the Grenadines","WS":"Samoa","SM":"San Marino","ST":"Sao Tome and Principe","SA":"Saudi Arabia","SN":"Senegal","RS":"Serbia","SC":"Seychelles","SL":"Sierra Leone","SG":"Singapore","SX":"Sint Maarten (Dutch part)","SK":"Slovakia","SI":"Slovenia","SB":"Solomon Islands","SO":"Somalia","ZA":"South Africa","GS":"South Georgia and the South Sandwich Islands","SS":"South Sudan","ES":"Spain","LK":"Sri Lanka","SD":"Sudan","SR":"Suriname","SJ":"Svalbard and Jan Mayen","SE":"Sweden","CH":"Switzerland","SY":"Syrian Arab Republic","TW":"Taiwan","TJ":"Tajikistan","TZ":"Tanzania","TH":"Thailand","TL":"Timor-Leste","TG":"Togo","TK":"Tokelau","TO":"Tonga","TT":"Trinidad and Tobago","TN":"Tunisia","TR":"Turkey","TM":"Turkmenistan","TC":"Turks and Caicos Islands","TV":"Tuvalu","UG":"Uganda","UA":"Ukraine","AE":"United Arab Emirates","GB":"United Kingdom","UM":"United States Minor Outlying Islands","US":"United States","UY":"Uruguay","UZ":"Uzbekistan","VU":"Vanuatu","VE":"Venezuela","VN":"Viet Nam","VG":"Virgin Islands, British","VI":"Virgin Islands, U.S.","WF":"Wallis and Futuna","EH":"Western Sahara","YE":"Yemen","ZM":"Zambia","ZW":"Zimbabwe"};

    const el = {
        body: document.body, categorySelect: document.getElementById('categorySelect'), channelList: document.getElementById('channelList'),
        channelSearch: document.getElementById('channelSearch'), videoPlayer: document.getElementById('videoPlayer'), videoContainer: document.getElementById('videoContainer'),
        stopButton: document.getElementById('stopButton'), nowPlaying: document.getElementById('nowPlaying'), errorMsg: document.getElementById('error-message'),
        loadingIndicator: document.getElementById('loading-indicator'), themeToggle: document.getElementById('themeToggle'), pipButton: document.getElementById('pipButton'),
        settingsToggle: document.getElementById('settingsToggle'), playlistSettings: document.getElementById('playlistSettings'), playlistUrlInput: document.getElementById('playlistUrlInput'),
        loadCustomBtn: document.getElementById('loadCustomPlaylist'), loadDefaultBtn: document.getElementById('loadDefaultPlaylist'), layoutToggle: document.getElementById('layoutToggle'),
        sentinel: document.getElementById('scroll-sentinel'), countrySelect: document.getElementById('countrySelect'), countryFilterContainer: document.getElementById('country-filter-container')
    };

    let allChannels = [], epgData = new Map(), countryData = new Map(), currentHlsInstance = null, currentPlayingUrl = null;
    let failedChannelUrls = new Set(), favoriteChannelUrls = new Set(), epgUpdateInterval = null;
    let currentlyDisplayedChannels = [], renderIndex = 0, virtualScrollObserver;

    const displayError = (msg) => { el.errorMsg.textContent = msg; setTimeout(() => el.errorMsg.textContent = '', 7000); };
    const debounce = (fn, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; };
    const loadFromStorage = (key, def) => { const s = localStorage.getItem(key); try { return s ? JSON.parse(s) : def; } catch (e) { return def; } };
    const saveToStorage = (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch (e) { console.error('Failed to save to storage', e); } };

    const applyTheme = (theme) => { el.body.classList.toggle('light-theme', theme === 'light'); el.themeToggle.innerHTML = `<i class="fas fa-${theme === 'light' ? 'sun' : 'moon'}"></i>`; };
    const toggleTheme = () => { const newTheme = el.body.classList.contains('light-theme') ? 'dark' : 'light'; saveToStorage(STORAGE_KEYS.THEME, newTheme); applyTheme(newTheme); };
    const initTheme = () => applyTheme(loadFromStorage(STORAGE_KEYS.THEME, window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

    const applyLayout = (layout) => { el.channelList.className = `${layout}-view`; el.layoutToggle.className = `fas fa-${layout === 'grid' ? 'list' : 'th-large'}`; };
    const toggleLayout = () => { const newLayout = el.channelList.classList.contains('list-view') ? 'grid' : 'list'; saveToStorage(STORAGE_KEYS.LAYOUT, newLayout); applyLayout(newLayout); };
    const initLayout = () => applyLayout(loadFromStorage(STORAGE_KEYS.LAYOUT, 'list'));

    const showLoading = (msg) => { el.loadingIndicator.querySelector('span').textContent = msg; el.loadingIndicator.classList.remove('hidden'); };
    const hideLoading = () => el.loadingIndicator.classList.add('hidden');

    const fetchIPTVData = async () => {
        clearInterval(epgUpdateInterval);
        const playlistUrl = loadFromStorage(STORAGE_KEYS.CUSTOM_URL, DEFAULT_PLAYLIST_URL);
        el.playlistUrlInput.value = playlistUrl;
        showLoading(`Loading channels from ${new URL(playlistUrl).hostname}...`);
        try {
            await fetchCountryData();
            const response = await fetch(playlistUrl);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const playlistText = await response.text();
            const { channels, epgUrl } = parseM3UPlaylist(playlistText);
            allChannels = channels;
            
            populateFilters();
            filterAndDisplayChannels();

            if (epgUrl) {
                showLoading(`Loading EPG data...`);
                await fetchEPGData(epgUrl);
                filterAndDisplayChannels();
                epgUpdateInterval = setInterval(updateEPGProgress, 60000);
            }
        } catch (error) { displayError(`Load failed: ${error.message}`); allChannels = []; filterAndDisplayChannels(); } finally { hideLoading(); }
    };
    
    const fetchCountryData = async () => {
        try {
            const response = await fetch(CHANNELS_METADATA_URL);
            if (!response.ok) throw new Error('Could not fetch channel metadata');
            const data = await response.json();
            countryData.clear();
            data.forEach(ch => { if (ch.id && ch.country) countryData.set(ch.id, ch.country) });
        } catch(e) {
            console.error("Could not load country data:", e);
            el.countryFilterContainer.classList.add('hidden');
        }
    };

    const parseM3UPlaylist = (txt) => {
        let channels = [], epgUrl = '', cur = {};
        const epgMatch = txt.match(/x-tvg-url="([^"]+)"/);
        if (epgMatch) epgUrl = epgMatch[1];
        txt.split('\n').forEach(line => {
            line = line.trim();
            if (line.startsWith('#EXTINF:')) {
                const info = line.match(/#EXTINF:-1([^,]*),(.*)/);
                if (!info) return;
                cur = { name: info[2].trim(), category: UNKNOWN_VALUE, url: '', logo: '', tvgId: '', country: '' };
                const attrs = info[1];
                cur.tvgId = (attrs.match(/tvg-id="([^"]+)"/i) || [])[1] || '';
                cur.category = (attrs.match(/group-title="([^"]+)"/i) || [])[1] || UNKNOWN_VALUE;
                cur.logo = (attrs.match(/tvg-logo="([^"]+)"/i) || [])[1] || '';
                if (cur.tvgId && countryData.has(cur.tvgId)) cur.country = countryData.get(cur.tvgId);
            } else if (line.startsWith('http') && cur.name) {
                cur.url = line;
                if (!/\.(?:txt|zip|xml)$/i.test(cur.url)) channels.push(cur);
                cur = {};
            }
        });
        return { channels: channels.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase())), epgUrl };
    };

    const fetchEPGData = async (url) => {
        const xmlText = await (await fetch(url)).text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");
        epgData.clear();
        xmlDoc.querySelectorAll('programme').forEach(p => {
            const id = p.getAttribute('channel');
            if (!id) return;
            if (!epgData.has(id)) epgData.set(id, []);
            const startStr = p.getAttribute('start'), endStr = p.getAttribute('stop');
            if (!startStr || !endStr) return;
            const start = new Date(startStr.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})\s([+-]\d{4})/, '$1-$2-$3T$4:$5:$6$7'));
            const end = new Date(endStr.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})\s([+-]\d{4})/, '$1-$2-$3T$4:$5:$6$7'));
            if (end > new Date()) epgData.get(id).push({ title: p.querySelector('title')?.textContent||'No Title', desc: p.querySelector('desc')?.textContent||'', start, end });
        });
    };

    const findCurrentProgram = (tvgId) => { const programs = epgData.get(tvgId); if (!programs) return null; const now = new Date(); return programs.find(p => now >= p.start && now < p.end); };
    const renderChannelChunk = (channels) => {
        const fragment = document.createDocumentFragment();
        const isLightTheme = el.body.classList.contains("light-theme");
        const defaultLogo = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='${isLightTheme ? "%23333" : "%23ccc"}'%3E%3Cpath d='M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z'/%3E%3C/svg%3E`;
        channels.forEach(ch => {
            const li = document.createElement('li');
            li.className = 'channel-item';
            li.dataset.channelUrl = ch.url; li.dataset.channelName = ch.name; li.dataset.tvgId = ch.tvgId;
            let epgHtml = '';
            const prog = findCurrentProgram(ch.tvgId);
            if (prog) {
                const progress = (new Date() - prog.start) / (prog.end - prog.start) * 100;
                epgHtml = `<div class="epg-info"><span class="epg-program" title="${prog.desc || ''}">${prog.title}</span><div class="epg-progress-bar"><div class="epg-progress" style="width: ${progress}%"></div></div></div>`;
            }
            li.innerHTML = `<div class="channel-details"><div class="channel-info"><img class="channel-logo" src="${ch.logo||defaultLogo}" alt="" onerror="this.src='${defaultLogo}'"><span class="channel-name">${ch.name}</span></div>${epgHtml}</div><div class="channel-actions"><i class="fa-regular fa-star favorite-icon"></i><i class="fas fa-play-circle play-icon"></i></div>`;
            fragment.appendChild(li);
        });
        el.channelList.appendChild(fragment);
        updateChannelListVisuals();
    };
    
    const renderMoreChannels = () => {
        const chunk = currentlyDisplayedChannels.slice(renderIndex, renderIndex + CHUNK_SIZE);
        renderChannelChunk(chunk);
        renderIndex += CHUNK_SIZE;
        if (renderIndex >= currentlyDisplayedChannels.length) { if (virtualScrollObserver) virtualScrollObserver.disconnect(); el.sentinel.classList.add('hidden'); }
    };
    
    const filterAndDisplayChannels = () => {
        const country = el.countrySelect.value; const category = el.categorySelect.value; const term = el.channelSearch.value.toLowerCase();
        let filtered = allChannels;
        if (country !== 'All') filtered = filtered.filter(c => c.country === country);
        if (category === FAVORITES_CATEGORY_VALUE) filtered = filtered.filter(c => favoriteChannelUrls.has(c.url));
        else if (category !== 'All') filtered = filtered.filter(c => c.category === category);
        if (term) filtered = filtered.filter(c => c.name.toLowerCase().includes(term));
        
        currentlyDisplayedChannels = filtered;
        el.channelList.innerHTML = ''; renderIndex = 0;
        
        if (virtualScrollObserver) virtualScrollObserver.disconnect();
        if (currentlyDisplayedChannels.length > 0) {
            el.sentinel.classList.remove('hidden');
            renderMoreChannels();
            virtualScrollObserver = new IntersectionObserver(entries => { if (entries[0].isIntersecting) renderMoreChannels(); }, { root: el.channelList });
            virtualScrollObserver.observe(el.sentinel);
        } else {
            el.channelList.innerHTML = '<li class="channel-item" style="justify-content: center; cursor: default; border:none; grid-column: 1 / -1;">No channels match criteria.</li>';
        }
    };
    const debouncedFilter = debounce(filterAndDisplayChannels, SEARCH_DEBOUNCE_MS);
    const updateEPGProgress = () => document.querySelectorAll('.channel-item').forEach(item => { const prog = findCurrentProgram(item.dataset.tvgId); if (prog) { const p = item.querySelector('.epg-progress'); if (p) p.style.width = `${(new Date() - prog.start) / (prog.end - prog.start) * 100}%`; } });

    const populateFilters = () => {
        const countries = [...new Set(allChannels.map(c => c.country).filter(c => c))].sort();
        if (countries.length > 0) {
            const currentCountry = el.countrySelect.value;
            el.countrySelect.innerHTML = '<option value="All">All Countries</option>';
            countries.forEach(c => el.countrySelect.add(new Option(COUNTRY_CODES[c] || c, c)));
            el.countrySelect.value = currentCountry;
            el.countryFilterContainer.classList.remove('hidden');
        } else {
            el.countryFilterContainer.classList.add('hidden');
        }

        const categories = [...new Set(allChannels.map(c => c.category))];
        const currentCat = el.categorySelect.value;
        el.categorySelect.innerHTML = '';
        if (favoriteChannelUrls.size > 0) el.categorySelect.add(new Option('Favorites â­', FAVORITES_CATEGORY_VALUE));
        el.categorySelect.add(new Option('All Categories', 'All'));
        categories.filter(c => c && c !== UNKNOWN_VALUE).sort().forEach(c => el.categorySelect.add(new Option(c, c)));
        if (categories.includes(UNKNOWN_VALUE)) el.categorySelect.add(new Option(UNKNOWN_VALUE, UNKNOWN_VALUE));
        el.categorySelect.value = [...el.categorySelect.options].some(o => o.value === currentCat) ? currentCat : 'All';
    };

    const updateChannelListVisuals = () => el.channelList.querySelectorAll('.channel-item').forEach(item => { const url = item.dataset.channelUrl; item.classList.toggle('active-channel', url === currentPlayingUrl); item.classList.toggle('failed-channel', failedChannelUrls.has(url)); item.classList.toggle('favorited', favoriteChannelUrls.has(url)); });
    
    const playChannel = (url, name) => {
        if (currentHlsInstance) currentHlsInstance.destroy();
        el.nowPlaying.textContent = `Loading: ${name}...`; currentPlayingUrl = url;
        updateChannelListVisuals(); el.videoContainer.classList.remove('hidden'); el.pipButton.classList.add('hidden');
        el.videoContainer.scrollIntoView();
        
        const onPlaySuccess = () => { el.nowPlaying.textContent = `Now Playing: ${name}`; if (document.pictureInPictureEnabled) el.pipButton.classList.remove('hidden'); };
        const onPlayError = (details = 'Playback failed') => {
            console.error(`Playback Error for ${name}:`, details); displayError(`Failed: ${name}`);
            failedChannelUrls.add(url); saveToStorage(STORAGE_KEYS.FAILED_CHANNELS, [...failedChannelUrls]);
            if(currentPlayingUrl === url) stopPlayback();
            else updateChannelListVisuals();
        };

        if (url.toLowerCase().includes('.m3u8')) {
            if (Hls.isSupported()) {
                currentHlsInstance = new Hls();
                currentHlsInstance.loadSource(url); currentHlsInstance.attachMedia(el.videoPlayer);
                currentHlsInstance.on(Hls.Events.MANIFEST_PARSED, () => el.videoPlayer.play().then(onPlaySuccess).catch(e => onPlayError(e.message)));
                currentHlsInstance.on(Hls.Events.ERROR, (evt, data) => { if (data.fatal) onPlayError(data.details); });
            } else if (el.videoPlayer.canPlayType('application/vnd.apple.mpegurl')) { el.videoPlayer.src = url; el.videoPlayer.play().then(onPlaySuccess).catch(e => onPlayError(e.message));
            } else { onPlayError('HLS not supported'); }
        } else { el.videoPlayer.src = url; el.videoPlayer.play().then(onPlaySuccess).catch(e => onPlayError(e.message)); }
    };

    const stopPlayback = () => {
        if (currentHlsInstance) { currentHlsInstance.destroy(); currentHlsInstance = null; }
        el.videoPlayer.pause(); el.videoPlayer.removeAttribute('src'); el.videoPlayer.load();
        el.videoContainer.classList.add('hidden'); el.pipButton.classList.add('hidden'); el.nowPlaying.textContent = ''; currentPlayingUrl = null;
        updateChannelListVisuals(); if (document.pictureInPictureElement) document.exitPictureInPicture();
    };

    const setupListeners = () => {
        [el.countrySelect, el.categorySelect].forEach(sel => sel.addEventListener('change', filterAndDisplayChannels));
        el.channelSearch.addEventListener('input', debouncedFilter);
        el.themeToggle.addEventListener('click', toggleTheme);
        el.layoutToggle.addEventListener('click', toggleLayout);
        el.settingsToggle.addEventListener('click', () => el.playlistSettings.classList.toggle('hidden'));
        el.loadCustomBtn.addEventListener('click', () => { const url = el.playlistUrlInput.value.trim(); if(url){ saveToStorage(STORAGE_KEYS.CUSTOM_URL, url); el.playlistSettings.classList.add('hidden'); fetchIPTVData(); }});
        el.loadDefaultBtn.addEventListener('click', () => { localStorage.removeItem(STORAGE_KEYS.CUSTOM_URL); el.playlistSettings.classList.add('hidden'); fetchIPTVData(); });
        el.stopButton.addEventListener('click', stopPlayback);
        el.pipButton.addEventListener('click', async () => { try { if (document.pictureInPictureElement) await document.exitPictureInPicture(); else await el.videoPlayer.requestPictureInPicture(); } catch(e) { displayError("PiP failed."); }});
        el.channelList.addEventListener('click', e => {
            const item = e.target.closest('.channel-item');
            if (!item || item.classList.contains('failed-channel')) return;
            const url = item.dataset.channelUrl, name = item.dataset.channelName;
            if (e.target.closest('.favorite-icon')) {
                e.stopPropagation();
                if (favoriteChannelUrls.has(url)) favoriteChannelUrls.delete(url); else favoriteChannelUrls.add(url);
                saveToStorage(STORAGE_KEYS.FAVORITES, [...favoriteChannelUrls]);
                populateFilters();
                if (el.categorySelect.value === FAVORITES_CATEGORY_VALUE) filterAndDisplayChannels(); else updateChannelListVisuals();
            } else if (url !== currentPlayingUrl) playChannel(url, name);
        });
    };

    const init = () => {
        initTheme();
        initLayout();
        failedChannelUrls = new Set(loadFromStorage(STORAGE_KEYS.FAILED_CHANNELS, []));
        favoriteChannelUrls = new Set(loadFromStorage(STORAGE_KEYS.FAVORITES, []));
        setupListeners();
        fetchIPTVData();
    };

    init();
</script>
</body>
</html>